<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Lichat</title>
    <link rel="stylesheet" href="stylesheet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="lichat.js"></script>
    <script type="text/x-template" id="emote-picker">
      <div class="emote-picker" v-bind:class="classes">
        <nav>
          <a class="emoji" v-on:click="tab = 'emoji'">
            <i class="fas fa-grin"></i>
          </a>
          <a class="emotes" v-on:click="tab = 'emotes'">
            <i class="fas fa-icons"></i>
          </a>
          <a class="back" v-on:click="$emit('close')">
            <i class="fas fa-times-circle"></i>
          </a>
        </nav>
        <ul class="emoji" v-show="tab == 'emoji'">
          <li v-for="emoji in allEmojis">
            <a class="emoji" v-on:click="$emit('close', emoji)">{{ emoji }}</a>
          </li>
        </ul>
        <ul class="emotes" v-show="tab == 'emotes'">
          <li v-for="emote in channel.getEmoteList">
            <a class="emote" v-on:click="$emit('close', emote)">
              <img v-bind:title="emote" src="channel.getEmote(emote)" />
            </a>
          </li>
        </ul>
      </div>
    </script>
    <script type="text/x-template" id="client-configure">
      <transition name="modal">
        <div class="popup-container" v-on:click.self="$emit('close', client)">
          <div class="popup">
            <header>
              <h2>Configure Client</h2>
            </header>
            <section>
              <div class="row">
                <label>Name</label>
                <input type="text" name="name" required v-model="client.name">
              </div>
              <div class="row">
                <label>Username</label>
                <input type="text" name="username" maxlength="32" required 
                       v-model="client.username"
                       v-bind:readonly="client.isConnected">
              </div>
              <div class="row">
                <label>Password</label>
                <input type="password" name="password" required
                       v-model="client.password"
                       v-bind:readonly="client.isConnected">
              </div>
              <div class="row">
                <label>Aliases</label>
                <input type="text" name="aliases" required v-model="client.aliases">
              </div>
              <div class="row">
                <label>Hostname</label>
                <input type="text" name="hostname" required
                       v-model="client.hostname"
                       v-bind:readonly="client.isConnected">
              </div>
              <div class="row">
                <label>Port</label>
                <input type="number" name="port" required
                       v-model="client.port"
                       v-bind:readonly="client.isConnected">
              </div>
              <div class="row">
                <label>SSL</label>
                <input type="checkbox" name="ssl"
                       v-model="client.ssl"
                       v-bind:readonly="client.isConnected">
              </div>
              <input type="button" value="Close" v-on:click="$emit('close', client)">
              <input type="button" value="Connect" v-if="!client.isConnected" v-on:click="$emit('close', client, true)">
            </section>
          </div>
        </div>
      </transition>
    </script>
  </head>
  <body>
    <div class="client">
      <nav v-show="0 < clients.length">
        <section class="server" v-for="client in clients">
          <client-configure
              v-bind:client="client"
              v-if="client.showSettings"
              v-on:close="saveClient"></client-configure>
          <header>
            <img class="icon" v-bind:src="client.icon">
            <span class="name">{{client.name || client.servername}}</span>
            <nav>
              <a class="settings" title="Configure this connection"
                 v-on:click="client.showSettings = true">
                <i class="fas fa-ellipsis-h"></i>
              </a>
            </nav>
          </header>
          <ul class="channels">
            <li class="channel"
                v-for="channel in client.channelList"
                v-bind:class="{current: channel == currentChannel, update: 0 < channel.unread, alert: channel.alerted, primary: channel.isPrimary}"
                v-on:click="switchChannel(channel)">
              <header>
                <img class="icon" v-bind:src="channel.icon">
                <span class="name">{{channel.name}}</span>
              </header>
              <div class="unread-count"
                   v-if="0 < channel.unread"
                   v-on:click="channel.unread = 0; channel.alerted = false">
                {{channel.unread}}
              </div>
            </li>
          </ul>
        </section>
      </nav>
      <divider></divider>
      <main v-if="currentChannel" v-on:drop.capture="uploadFile">
        <header>
          <img class="icon" v-bind:src="currentChannel.icon">
          <span class="name">{{currentChannel.name}}</span>
          <span class="topic">{{currentChannel.topic}}</span>
          <nav>
            <input type="text" placeholder="from:user something" ref="search"
                   v-model="search"
                   v-if="search !== null"
                   v-on:keyup.enter.prevent.stop="performSearch">
            <a class="search"
               v-if="currentChannel.client.isAvailable('shirakumo-search')"
               v-on:click="toggleSearch">
              <i class="fas fa-search"></i>
            </a>
            <a class="info">
              <i class="fas fa-info-circle"></i>
            </a>
            <a class="settings">
              <i class="fas fa-ellipsis-h"></i>
            </a>
          </nav>
        </header>
        <section class="output">
          <div class="message" v-for="message in currentChannel.messageList"
               v-bind:class="[{alert: message.isAlert, system: message.isSystem, bridged: message.isBridged}, message.type]"
               v-bind:id="message.gid">
            <header>
              <time v-bind:title="message.date">{{message.time}}</time>
              <img class="icon" v-bind:src="message.author.icon">
              <span class="name" 
                    v-bind:style="{color: message.author.color}"
                    v-bind:title="message.author.name"
                    v-bind:class="{me: message.author == currentChannel.client.user}">{{message.from}}</span>
            </header>
            <a class="reply-to" v-if="message.replyTo" v-bind:href="message.replyTo.url">
              <span class="name" v-bind:class="{me: message.replyTo.author == currentChannel.client.user}">{{message.replyTo.author.name}}</span>
              <p>{{message.replyTo.shortText}}</p>
            </a>
            <div class="content">
              <img v-if="message.isImage" v-bind:src="message.text">
              <video controls v-else-if="message.isVideo">
                <source v-bind:src="message.text" v-bind:type="message.contentType">
              </video>
              <audio controls v-else-if="message.isAudio">
                <source v-bind:src="message.text" v-bind:type="message.contentType">
              </audio>
              <p v-else v-html="message.html"></p>
              <div class="reactions">
                <a class="reaction"
                   v-for="reaction in message.reactions" 
                   v-bind:title="reaction.description"
                   v-on:click="message.sendReaction(reaction.text)">
                  <img v-if="reaction.image" v-bind:src="reaction.image">
                  <i v-else>{{reaction.text}}</i>
                  <span>{{reaction.count}}</span>
                </a>
              </div>
            </div>
            <nav>
              <a class="edit"
                 v-if="message.author.isSelf && message.type == 'message' && currentChannel.client.isAvailable('shirakumo-edit')">
                <i class="fas fa-edit"></i>
              </a>
              <a class="reply"
                 v-if="!message.isVirtual && currentChannel.client.isAvailable('shirakumo-replies')"
                 v-on:click="currentChannel.currentMessage.replyTo = message">
                <i class="fas fa-reply"></i>
              </a>
              <emote-picker
                  v-bind:channel="message.channel"
                  v-bind:classes="['small']"
                  v-if="message.showEmotePicker"
                  v-on:close="(ev)=>message.sendReaction.call(message, ev)"></emote-picker>
              <a class="react"
                 v-if="!message.isVirtual && currentChannel.client.isAvailable('shirakumo-reactions')"
                 v-on:click="message.showEmotePicker = !message.showEmotePicker">
                <i class="fas fa-surprise"></i>
              </a>
              <a class="settings"
                 v-if="!message.isVirtual">
                <i class="fas fa-ellipsis-h"></i>
              </a>
            </nav>
          </div>
        </section>
        <footer v-if="currentChannel.isPresent">
          <div class="user me">
            <img class="icon" v-bind:src="currentChannel.client.user.icon">
          </div>
          <div class="content">
            <a class="reply-to" v-if="currentChannel.currentMessage.replyTo" v-on:click="currentChannel.currentMessage.replyTo = null">
              <span class="name" v-bind:class="{me: currentChannel.currentMessage.replyTo.author == currentChannel.client.user}">{{currentChannel.currentMessage.replyTo.author.name}}</span>
              <p>{{currentChannel.currentMessage.replyTo.shortText}}</p>
            </a>
            <textarea placeholder="Write something..." autofocus ref="input"
                      v-model="currentChannel.currentMessage.text"
                      v-on:keyup.enter.prevent.stop="submit"></textarea>
          </div>
          <nav>
            <emote-picker
                v-bind:channel="currentChannel"
                v-bind:classes="['big']"
                v-show="showEmotePicker"
                v-on:close="addEmote"></emote-picker>
            <a class="emote" v-on:click="showEmotePicker = !showEmotePicker">
              <i class="fas fa-smile"></i>
            </a>
            <input type="file" accept=".png,.jpg,.jpeg,.gif,.mp4,.webm,.mp3,.ogg" id="fileChooser" style="display:none" v-on:change="uploadFile">
            <a class="upload" v-on:click="uploadFile">
              <i class="fas fa-paperclip"></i>
            </a>
          </nav>
        </footer>
      </main>
      <main v-else>
        <client-configure
            v-bind:client="{...defaultClient}"
            v-on:close="addClient"></client-configure>
      </main>
    </div>
    <script>var lichat = new LichatUI();</script>
  </body>
</html>
